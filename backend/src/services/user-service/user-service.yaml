openapi: 3.0.3
info:
  title: DietiEstates25 User Service
  version: 1.0.0
  description: Gestione profili utenti, preferenze e favorites

servers:
  - url: http://localhost:3004
    description: Development server

paths:
  /users/profile:
    get:
      operationId: getProfile
      summary: Ottieni profilo utente corrente
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      operationId: updateProfile
      summary: Aggiorna profilo utente
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdateRequest'
      responses:
        '200':
          description: Profile updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/{userId}:
    get:
      operationId: getUserById
      summary: Ottieni profilo utente pubblico
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Public user profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicUser'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/agents:
    get:
      operationId: getAgents
      summary: Lista degli agenti
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
            minimum: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
        - name: city
          in: query
          schema:
            type: string
        - name: specialization
          in: query
          schema:
            type: string
        - name: minRating
          in: query
          schema:
            type: number
            format: float
            minimum: 0
            maximum: 5
      responses:
        '200':
          description: List of agents
          content:
            application/json:
              schema:
                type: object
                properties:
                  agents:
                    type: array
                    items:
                      $ref: '#/components/schemas/Agent'
                  totalCount:
                    type: integer
                  currentPage:
                    type: integer
                  totalPages:
                    type: integer

  /users/preferences:
    get:
      operationId: getUserPreferences
      summary: Ottieni preferenze utente
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User preferences
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPreferences'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      operationId: updateUserPreferences
      summary: Aggiorna preferenze utente
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserPreferencesUpdate'
      responses:
        '200':
          description: Preferences updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPreferences'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/favorites:
    get:
      operationId: getUserFavorites
      summary: Ottieni proprietà preferite
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
            minimum: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: Favorite properties
          content:
            application/json:
              schema:
                type: object
                properties:
                  favorites:
                    type: array
                    items:
                      $ref: '#/components/schemas/PropertyFavorite'
                  totalCount:
                    type: integer
                  currentPage:
                    type: integer
                  totalPages:
                    type: integer
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      operationId: addToFavorites
      summary: Aggiungi proprietà ai preferiti
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - propertyId
              properties:
                propertyId:
                  type: string
                  format: uuid
      responses:
        '201':
          description: Added to favorites
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PropertyFavorite'
        '400':
          description: Property already in favorites or invalid ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Property not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/favorites/{propertyId}:
    delete:
      operationId: removeFromFavorites
      summary: Rimuovi dai preferiti
      security:
        - bearerAuth: []
      parameters:
        - name: propertyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Removed from favorites
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Favorite not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/favorites/{propertyId}/check:
    get:
      operationId: checkIfFavorite
      summary: Verifica se proprietà è nei preferiti
      security:
        - bearerAuth: []
      parameters:
        - name: propertyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Favorite status
          content:
            application/json:
              schema:
                type: object
                properties:
                  isFavorite:
                    type: boolean
                  favoriteId:
                    type: string
                    format: uuid
                    nullable: true
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/activity:
    get:
      operationId: getUserActivity
      summary: Ottieni attività utente (views, ricerche, etc.)
      security:
        - bearerAuth: []
      parameters:
        - name: type
          in: query
          schema:
            type: string
            enum: [views, searches, favorites]
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
        - name: days
          in: query
          schema:
            type: integer
            default: 30
            minimum: 1
            maximum: 365
      responses:
        '200':
          description: User activity
          content:
            application/json:
              schema:
                type: object
                properties:
                  views:
                    type: array
                    items:
                      $ref: '#/components/schemas/PropertyView'
                  searches:
                    type: integer
                  favorites:
                    type: integer
                  totalActivity:
                    type: integer
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/avatar:
    post:
      operationId: uploadUserAvatar
      summary: Upload avatar utente
      security:
        - bearerAuth: []
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - avatar
              properties:
                avatar:
                  type: string
                  format: binary
      responses:
        '200':
          description: Avatar uploaded
          content:
            application/json:
              schema:
                type: object
                properties:
                  avatarUrl:
                    type: string
                    format: uri
        '400':
          description: Invalid file
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        firstName:
          type: string
        lastName:
          type: string
        role:
          type: string
          enum: [client, agent, admin]
        avatar:
          type: string
          format: uri
        phone:
          type: string
        isVerified:
          type: boolean
        preferences:
          $ref: '#/components/schemas/UserPreferences'
        licenseNumber:
          type: string
          description: "Only for agents"
        biography:
          type: string
          description: "Only for agents"
        rating:
          type: number
          format: float
          minimum: 0
          maximum: 5
          description: "Only for agents"
        reviewsCount:
          type: integer
          minimum: 0
          description: "Only for agents"
        specializations:
          type: array
          items:
            type: string
          description: "Only for agents"
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        agency:
          allOf:
            - $ref: '#/components/schemas/Agency'
          description: "Agenzia di appartenenza (se l'utente è un agent)"

    PublicUser:
      type: object
      properties:
        id:
          type: string
          format: uuid
        firstName:
          type: string
        lastName:
          type: string
        role:
          type: string
          enum: [client, agent, admin]
        avatar:
          type: string
          format: uri
        agency:
          allOf:
            - $ref: '#/components/schemas/Agency'
          description: "Agenzia di appartenenza (se l'utente è un agent)"
        rating:
          type: number
          format: float
          description: "Only for agents"
        reviewsCount:
          type: integer
          description: "Only for agents"
        specializations:
          type: array
          items:
            type: string
          description: "Only for agents"
        biography:
          type: string
          description: "Only for agents"
        createdAt:
          type: string
          format: date-time

    Agent:
      allOf:
        - $ref: '#/components/schemas/PublicUser'
        - type: object
          properties:
            phone:
              type: string
            licenseNumber:
              type: string
            totalProperties:
              type: integer
              minimum: 0
            activeProperties:
              type: integer
              minimum: 0

    UserUpdateRequest:
      type: object
      properties:
        firstName:
          type: string
          minLength: 2
          maxLength: 50
        lastName:
          type: string
          minLength: 2
          maxLength: 50
        phone:
          type: string
          pattern: '^\+?[1-9]\d{1,14}$'
        biography:
          type: string
          maxLength: 1000
          description: "Only for agents"
        agencyName:
          type: string
          maxLength: 200
          description: "Only for agents"
        specializations:
          type: array
          items:
            type: string
          maxItems: 10
          description: "Only for agents"

    UserPreferences:
      type: object
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        emailNotifications:
          type: boolean
          default: true
        pushNotifications:
          type: boolean
          default: true
        notificationTypes:
          type: array
          items:
            $ref: '#/components/schemas/NotificationType'
        searchRadius:
          type: number
          format: float
          minimum: 1
          maximum: 100
          default: 10
        preferredLocations:
          type: array
          items:
            type: string
        marketingEmails:
          type: boolean
          default: true
        weeklyDigest:
          type: boolean
          default: true
        language:
          type: string
          enum: [it, en]
          default: it
        currency:
          type: string
          enum: [EUR, USD]
          default: EUR
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    UserPreferencesUpdate:
      type: object
      properties:
        emailNotifications:
          type: boolean
        pushNotifications:
          type: boolean

        notificationTypes:
          type: array
          items:
            $ref: '#/components/schemas/NotificationType'
        searchRadius:
          type: number
          format: float
          minimum: 1
          maximum: 100
        preferredLocations:
          type: array
          items:
            type: string
        marketingEmails:
          type: boolean
        weeklyDigest:
          type: boolean
        language:
          type: string
          enum: [it, en]
        currency:
          type: string
          enum: [EUR, USD]

    PropertyFavorite:
      type: object
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        propertyId:
          type: string
          format: uuid
        property:
          $ref: '#/components/schemas/Property'
        createdAt:
          type: string
          format: date-time

    PropertyView:
      type: object
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        propertyId:
          type: string
          format: uuid
        property:
          $ref: '#/components/schemas/PropertySummary'
        viewedAt:
          type: string
          format: date-time
        source:
          type: string
          enum: [search, direct, notification, favorite]

    Property:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        description:
          type: string
        price:
          type: number
          format: float
        propertyType:
          type: string
          enum: [apartment, villa, house, loft, office, commercial, land]
        listingType:
          type: string
          enum: [sale, rent]
        status:
          type: string
          enum: [active, pending, sold, rented, withdrawn]
        bedrooms:
          type: integer
        bathrooms:
          type: integer
        area:
          type: number
          format: float
        address:
          $ref: '#/components/schemas/PropertyAddress'
        images:
          type: array
          items:
            $ref: '#/components/schemas/PropertyImage'
        agentId:
          type: string
          format: uuid
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    PropertySummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        price:
          type: number
          format: float
        propertyType:
          type: string
        listingType:
          type: string
        address:
          $ref: '#/components/schemas/PropertyAddress'
        primaryImage:
          $ref: '#/components/schemas/PropertyImage'

    PropertyAddress:
      type: object
      properties:
        street:
          type: string
        city:
          type: string
        province:
          type: string
        zipCode:
          type: string
        country:
          type: string

    PropertyImage:
      type: object
      properties:
        id:
          type: string
          format: uuid
        url:
          type: string
          format: uri
        alt:
          type: string
        isPrimary:
          type: boolean
        order:
          type: integer

    NotificationType:
      type: string
      enum:
        - new_property_match
        - price_change
        - property_status_change
        - saved_search_results
        - account_verification
        - property_view
        - favorite_added
        - message_received
        - system_maintenance

    Agency:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        address:
          type: string
        city:
          type: string
        postalCode:
          type: string
        country:
          type: string
        phone:
          type: string
        email:
          type: string
          format: email
        website:
          type: string
          format: uri
        logo:
          type: string
          format: uri
        licenseNumber:
          type: string
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: object
        timestamp:
          type: string
          format: date-time
