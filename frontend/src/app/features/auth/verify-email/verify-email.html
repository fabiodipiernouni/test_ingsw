<app-auth-layout [config]="authConfig">
  @if (!emailVerified()) {
    <!-- Step 1: Email form -->
    @if (!codeSent()) {
      <form [formGroup]="emailForm" (ngSubmit)="sendCode()">
        <div class="form-fields">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Email</mat-label>
            <input matInput
                   type="email"
                   formControlName="email"
                   placeholder="mario.rossi@email.com"
                   autocomplete="email">
            <mat-icon matSuffix>email</mat-icon>
            <mat-error>{{ getErrorMessage('email') }}</mat-error>
          </mat-form-field>
        </div>

        <button mat-raised-button
                color="primary"
                type="submit"
                class="submit-button"
                [disabled]="!emailForm.valid || isLoading()">
          @if (isLoading()) {
            <ng-container>
              <mat-icon class="spin">refresh</mat-icon>
              Invio in corso...
            </ng-container>
          } @else {
            <ng-container>
              <mat-icon>send</mat-icon>
              Invia codice
            </ng-container>
          }
        </button>
      </form>
    }

    <!-- Step 2: Verification code form -->
    @if (codeSent()) {
      <form [formGroup]="verificationForm" (ngSubmit)="onSubmit()">
        <div class="form-fields">
          <div class="email-info">
            <p class="sent-to">Codice inviato a: <strong>{{ emailForm.value.email }}</strong></p>
            <button type="button" 
                    class="change-email-link" 
                    (click)="goBackToEmail()">
              Cambia email
            </button>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Codice di verifica</mat-label>
            <input matInput
                   type="text"
                   formControlName="code"
                   placeholder="Inserisci il codice ricevuto via email"
                   autocomplete="off">
            <mat-icon matSuffix>vpn_key</mat-icon>
            <mat-error>{{ getErrorMessage('code') }}</mat-error>
          </mat-form-field>

          <div class="resend-code-container">
            <p class="resend-text">Non hai ricevuto il codice?</p>
            <button type="button"
                    mat-button
                    color="primary"
                    class="resend-button"
                    (click)="sendCode()"
                    [disabled]="isLoading()">
              <mat-icon>refresh</mat-icon>
              Invia di nuovo
            </button>
          </div>
        </div>

        <button mat-raised-button
                color="primary"
                type="submit"
                class="submit-button"
                [disabled]="!verificationForm.valid || isLoading()">
          @if (isLoading()) {
            <ng-container>
              <mat-icon class="spin">refresh</mat-icon>
              Verifica in corso...
            </ng-container>
          } @else {
            <ng-container>
              <mat-icon>check</mat-icon>
              Verifica email
            </ng-container>
          }
        </button>
      </form>
    }
  } @else {
    <div class="success-message">
      <mat-icon class="success-icon">check_circle</mat-icon>
      <h2>Email verificata!</h2>
      <p>La tua email Ã¨ stata verificata con successo.</p>
      <p class="info">Ora puoi accedere al tuo account con le tue credenziali.</p>
      
      <button mat-raised-button 
              color="primary" 
              class="login-button"
              (click)="goToLogin()">
        <mat-icon>login</mat-icon>
        Vai al login
      </button>
    </div>
  }
</app-auth-layout>
