<div class="change-password-container">
  <mat-card class="password-form-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>security</mat-icon>
        Cambia Password
      </mat-card-title>
      <mat-card-subtitle>
        Aggiorna la tua password per mantenere sicuro il tuo account
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="changePasswordForm" (ngSubmit)="onSubmit()">
        
        <!-- Current Password -->
        <div class="form-section">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Password Attuale</mat-label>
            <input matInput
                   [type]="hideCurrentPassword() ? 'password' : 'text'"
                   formControlName="currentPassword"
                   placeholder="Inserisci la password attuale"
                   autocomplete="current-password">
            <button mat-icon-button
                    matSuffix
                    type="button"
                    (click)="hideCurrentPassword.set(!hideCurrentPassword())"
                    [attr.aria-label]="'Toggle current password visibility'"
                    [attr.aria-pressed]="!hideCurrentPassword()">
              <mat-icon>{{ hideCurrentPassword() ? 'visibility_off' : 'visibility' }}</mat-icon>
            </button>
            <mat-error>{{ getErrorMessage('currentPassword') }}</mat-error>
          </mat-form-field>
        </div>

        <!-- New Password -->
        <div class="form-section">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Nuova Password</mat-label>
            <input matInput
                   [type]="hideNewPassword() ? 'password' : 'text'"
                   formControlName="newPassword"
                   placeholder="Scegli una nuova password sicura"
                   autocomplete="new-password">
            <button mat-icon-button
                    matSuffix
                    type="button"
                    (click)="hideNewPassword.set(!hideNewPassword())"
                    [attr.aria-label]="'Toggle new password visibility'"
                    [attr.aria-pressed]="!hideNewPassword()">
              <mat-icon>{{ hideNewPassword() ? 'visibility_off' : 'visibility' }}</mat-icon>
            </button>
            <mat-error>{{ getErrorMessage('newPassword') }}</mat-error>
          </mat-form-field>

          <!-- Password Requirements -->
          @if (passwordRequirements()) {
            <div class="password-requirements">
              <p>La nuova password deve contenere:</p>
              <ul>
                <li [class.valid]="passwordChecks().hasLower">
                  <mat-icon>{{ passwordChecks().hasLower ? 'check' : 'close' }}</mat-icon>
                  Almeno una lettera minuscola
                </li>
                <li [class.valid]="passwordChecks().hasUpper">
                  <mat-icon>{{ passwordChecks().hasUpper ? 'check' : 'close' }}</mat-icon>
                  Almeno una lettera maiuscola
                </li>
                <li [class.valid]="passwordChecks().hasNumber">
                  <mat-icon>{{ passwordChecks().hasNumber ? 'check' : 'close' }}</mat-icon>
                  Almeno un numero
                </li>
                <li [class.valid]="passwordChecks().hasSpecial">
                  <mat-icon>{{ passwordChecks().hasSpecial ? 'check' : 'close' }}</mat-icon>
                  Almeno un carattere speciale
                </li>
                <li [class.valid]="passwordChecks().hasLength">
                  <mat-icon>{{ passwordChecks().hasLength ? 'check' : 'close' }}</mat-icon>
                  Almeno 8 caratteri
                </li>
              </ul>
            </div>
          }
        </div>

        <!-- Confirm New Password -->
        <div class="form-section">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Conferma Nuova Password</mat-label>
            <input matInput
                   [type]="hideConfirmPassword() ? 'password' : 'text'"
                   formControlName="confirmPassword"
                   placeholder="Ripeti la nuova password"
                   autocomplete="new-password">
            <button mat-icon-button
                    matSuffix
                    type="button"
                    (click)="hideConfirmPassword.set(!hideConfirmPassword())"
                    [attr.aria-label]="'Toggle confirm password visibility'"
                    [attr.aria-pressed]="!hideConfirmPassword()">
              <mat-icon>{{ hideConfirmPassword() ? 'visibility_off' : 'visibility' }}</mat-icon>
            </button>
            <mat-error>{{ getErrorMessage('confirmPassword') }}</mat-error>
          </mat-form-field>
        </div>

        <!-- Security Tips -->
        <div class="security-tips">
          <h4>
            <mat-icon>tips_and_updates</mat-icon>
            Consigli per la sicurezza
          </h4>
          <ul>
            <li>Usa una password unica che non utilizzi altrove</li>
            <li>Evita informazioni personali facilmente indovinabili</li>
            <li>Considera l'uso di un gestore di password</li>
            <li>Cambia la password regolarmente</li>
          </ul>
        </div>

      </form>
    </mat-card-content>

    <mat-card-actions class="form-actions">
      <button mat-button 
              type="button" 
              (click)="onReset()"
              [disabled]="isLoading()">
        <mat-icon>refresh</mat-icon>
        Reset
      </button>

      <button mat-raised-button 
              color="primary" 
              type="submit"
              (click)="onSubmit()"
              [disabled]="!changePasswordForm.valid || isLoading()">
        @if (isLoading()) {
          <ng-container>
            <mat-icon class="spin">refresh</mat-icon>
            Aggiornamento...
          </ng-container>
        } @else {
          <ng-container>
            <mat-icon>lock_reset</mat-icon>
            Cambia Password
          </ng-container>
        }
      </button>
    </mat-card-actions>
  </mat-card>
</div>