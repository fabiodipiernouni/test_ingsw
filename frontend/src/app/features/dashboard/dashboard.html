<div class="dashboard-container">
    <app-user-warning></app-user-warning>

    <header class="dashboard-header">
    <h1>Benvenuto, {{ currentUser?.firstName }}!</h1>
    <p class="subtitle">
        {{ getUserRoleLabel() }} - {{ getRoleDescription() }}
    </p>
    </header>

    <div class="dashboard-grid">

    <!-- Card per Gestione Agenzia (per owner e admin) -->
    @if (canManageAgency()) {
    <mat-card class="action-card clickable-card" routerLink="/admin/manage-agency">
        <mat-card-header>
        <mat-icon mat-card-avatar style="color: #2196f3">business</mat-icon>
        <mat-card-title>Gestisci Agenzia</mat-card-title>
        <mat-card-subtitle>Visualizza e gestisci gli utenti della tua agenzia</mat-card-subtitle>
        </mat-card-header>
    </mat-card>
    }

    <!-- Card per Creazione Admin (solo per owner) -->
    @if (canCreateAdmins()) {
    <mat-card class="action-card clickable-card" routerLink="/create-admin">
        <mat-card-header>
        <mat-icon mat-card-avatar style="color: #ff9800">admin_panel_settings</mat-icon>
        <mat-card-title>Crea Amministratore</mat-card-title>
        <mat-card-subtitle>Crea un nuovo account amministratore</mat-card-subtitle>
        </mat-card-header>
    </mat-card>
    }

    <!-- Card per Creazione Agenti (per owner e admin) -->
    @if (canCreateAgents()) {
    <mat-card class="action-card clickable-card" routerLink="/create-agent">
        <mat-card-header>
        <mat-icon mat-card-avatar style="color: #4caf50">person_add</mat-icon>
        <mat-card-title>Crea Agente</mat-card-title>
        <mat-card-subtitle>Aggiungi un nuovo agente immobiliare</mat-card-subtitle>
        </mat-card-header>
    </mat-card>
    }

    <!-- Card per Messaggi Promozionali (per owner e admin) -->
    @if (canSendPromotions()) {
    <mat-card class="action-card clickable-card" routerLink="/send-promotional-message">
        <mat-card-header>
        <mat-icon mat-card-avatar style="color: #9c27b0">campaign</mat-icon>
        <mat-card-title>Messaggi Promozionali</mat-card-title>
        <mat-card-subtitle>Invia notifiche promozionali agli utenti</mat-card-subtitle>
        </mat-card-header>
    </mat-card>
    }

    <!-- Card per Ricerca -->
    <mat-card class="action-card clickable-card" routerLink="/search">
        <mat-card-header>
        <mat-icon mat-card-avatar color="primary">search</mat-icon>
        <mat-card-title>Cerca Immobili</mat-card-title>
        <mat-card-subtitle>Trova la propriet√† perfetta per te</mat-card-subtitle>
        </mat-card-header>
    </mat-card>

    <!-- Card per Ricerche Salvate -->
    <mat-card class="action-card clickable-card" routerLink="/saved-searches">
        <mat-card-header>
        <mat-icon mat-card-avatar color="accent">bookmark</mat-icon>
        <mat-card-title>Ricerche Salvate</mat-card-title>
        <mat-card-subtitle>Visualizza le tue ricerche preferite</mat-card-subtitle>
        </mat-card-header>
    </mat-card>

    <!-- Card per I Miei Immobili (solo per agenti) -->
    @if (canUploadProperties()) {
    <mat-card class="action-card clickable-card" (click)="goToMyProperties()" (keydown.enter)="goToMyProperties()" (keydown.space)="goToMyProperties()" tabindex="0">
        <mat-card-header>
        <mat-icon mat-card-avatar style="color: #4caf50">home_work</mat-icon>
        <mat-card-title>I Miei Immobili</mat-card-title>
        <mat-card-subtitle>Visualizza e gestisci i tuoi immobili</mat-card-subtitle>
        </mat-card-header>
    </mat-card>
    }

    <!-- Card per Immobili dell'Agenzia (per owner, admin e agenti) -->
    @if (canViewAgencyProperties()) {
    <mat-card class="action-card clickable-card" (click)="goToAgencyProperties()" (keydown.enter)="goToAgencyProperties()" (keydown.space)="goToAgencyProperties()" tabindex="0">
        <mat-card-header>
        <mat-icon mat-card-avatar style="color: #2196f3">business</mat-icon>
        <mat-card-title>Immobili dell'Agenzia</mat-card-title>
        <mat-card-subtitle>Visualizza tutti gli immobili dell'agenzia</mat-card-subtitle>
        </mat-card-header>
    </mat-card>
    }

    <!-- Card per Agenti (solo per agenti) -->
    @if (isAgent()) {
    <mat-card class="action-card clickable-card" routerLink="/properties/upload">
        <mat-card-header>
        <mat-icon mat-card-avatar>home</mat-icon>
        <mat-card-title>Carica Immobile</mat-card-title>
        <mat-card-subtitle>Aggiungi un nuovo immobile</mat-card-subtitle>
        </mat-card-header>
    </mat-card>
    }

    </div>

    <!-- Informazioni Account -->
    <mat-card class="account-card">
    <mat-card-header>
        <mat-icon mat-card-avatar>account_circle</mat-icon>
        <mat-card-title>Il Tuo Account</mat-card-title>
    </mat-card-header>
    <mat-card-content>
        <div class="account-info">
        <p><strong>Nome:</strong> {{ currentUser?.firstName }} {{ currentUser?.lastName }}</p>
        <p><strong>Email:</strong> <a href="mailto:{{ currentUser?.email }}">{{ currentUser?.email }}</a></p>
        @if (currentUser?.phone; as phone) {
        <p><strong>Telefono:</strong> <a href="tel:{{ phone }}">{{ phone }}</a></p>
        }
        <p><strong>Tipo Account:</strong>
            <mat-chip [color]="currentUser?.role === 'agent' ? 'accent' : 'primary'">
            {{ getUserRoleLabel() }}
            </mat-chip>
        </p>
        @if (currentUser?.agency; as agency) {
        <div class="agency-info">
          <p><strong>Agenzia:</strong> {{ agency?.name }}</p>
          @if (agency?.description; as description) {
          <p><strong>Descrizione:</strong> {{ description }}</p>
          }
          @if (agency?.address; as address) {
          <p><strong>Indirizzo:</strong>
            @if(address?.street) {
                {{ address.street }}
            }
            @if (address?.zipCode; as zipCode) {
            <span> ({{ zipCode }})</span>
            }
            @if (address?.city; as city) {
            <span>, {{ city }}</span>
            }
          </p>
          }
          @if (agency?.contacts?.phone; as phone) {
          <p><strong>Telefono Agenzia:</strong> <a href="tel:{{ phone }}">{{ phone }}</a></p>
          }
          @if (agency?.contacts?.email; as email) {
          <p><strong>Email Agenzia:</strong> <a href="mailto:{{ email }}">{{ email }}</a></p>
          }
          @if (agency?.contacts?.website; as website) {
          <p><strong>Sito Web: </strong>
            <a [href]="website" target="_blank" rel="noopener">{{ website }}</a>
          </p>
          }
          @if (agency?.licenseNumber; as licenseNumber) {
            <p><strong>Numero Licenza:</strong> {{ licenseNumber }}</p>
          }
        </div>
        }
        @if (currentUser?.licenseNumber) {
        <p><strong>Licenza:</strong> {{ currentUser?.licenseNumber }}</p>
        }
        @if (currentUser?.lastLoginAt) {
        <p><strong>Ultimo Accesso:</strong> {{ formatDate(currentUser?.lastLoginAt) }}</p>
        }
        @else {
            <p><strong>Ultimo Accesso:</strong> Primo Accesso</p>
        }
        <p><strong>Membro dal:</strong> {{ formatDate(currentUser?.createdAt) }}</p>
        </div>
    </mat-card-content>
    <mat-card-actions>
        <button mat-button color="primary" routerLink="/profile">Profilo</button>
        <button mat-button color="warn" (click)="logout()">Esci</button>
    </mat-card-actions>
    </mat-card>
</div>
